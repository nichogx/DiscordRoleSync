# Discord Role Sync

[![Latest Release](https://gitlab.com/nichogx/DiscordRoleSync/-/badges/release.svg)](https://gitlab.com/nichogx/DiscordRoleSync/-/releases)
[![Game Versions](https://img.shields.io/modrinth/game-versions/g5nO2LNq?label=Game%20Versions)](https://modrinth.com/plugin/discordrolesync)
[![Modrinth](https://img.shields.io/modrinth/dt/g5nO2LNq?logo=modrinth&label=Modrinth)](https://modrinth.com/plugin/discordrolesync)
[![SpigotMC](https://img.shields.io/spiget/downloads/78829?logo=spigotmc&label=SpigotMC)](https://www.spigotmc.org/resources/discord-role-sync.78829)
[![Hangar](https://img.shields.io/hangar/dt/discordrolesync?logo=data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjxzdmcKICAgd2lkdGg9IjIxLjM5MTk5OG1tIgogICBoZWlnaHQ9IjI3LjYyMDc0MW1tIgogICB2aWV3Qm94PSIwIDAgMjEuMzkxOTk4IDI3LjYyMDc0MSIKICAgdmVyc2lvbj0iMS4xIgogICBpZD0ic3ZnNzQxIgogICB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciCiAgIHhtbG5zOnN2Zz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgogIDxkZWZzCiAgICAgaWQ9ImRlZnM3MzgiIC8+CiAgPGcKICAgICBpZD0ibGF5ZXIxIgogICAgIHRyYW5zZm9ybT0idHJhbnNsYXRlKC03Ni4xNzIyMDksLTEyNy42NTA5KSI+CiAgICA8cGF0aAogICAgICAgZD0ibSA5NS44ODgzNjEsMTM5LjUwMDE4IGMgLTIuMDk0NDUsLTAuNzY5NDEgLTUuMTc5NTA0LDIuMjA5NDUgLTYuNjg5NzUyLDYuNzczNjggLTAuNzQ5NjU2LDIuMjc0MDEgLTEuMTExNjA4LDQuOTQxMDEgLTAuNzYzNDE0LDcuNzM0MyBsIC0wLjk2ODczMiwtMC40MDQyOCBjIC0xLjg0NzE1MywtNS43NjA4NiAtMC44MTEzOTQsLTEyLjA2MDA2IDIuMzg5MDIxLC0xNi42MDgwNyB6IgogICAgICAgc3R5bGU9ImZpbGw6I2ZmZmZmZjtmaWxsLW9wYWNpdHk6MTtmaWxsLXJ1bGU6bm9uemVybztzdHJva2U6bm9uZTtzdHJva2Utd2lkdGg6MC4zNTI3NzgiCiAgICAgICBpZD0icGF0aDE2Ny02LTEiIC8+CiAgICA8cGF0aAogICAgICAgZD0ibSA5Ny4yMzU3MzEsMTQ5LjM0Nzk3IC03LjE2NzA2MywtMi45NzAwNCBjIDEuMzI1MDM5LC0zLjk4OTIxIDMuNzUzNTcxLC02LjM2OTc1IDUuMzM5NjY2LC02LjM2OTc1IDAuMTY4Mjc2LDAgMC4zMjU2MTUsMC4wMjc5IDAuNDcxNjY2LDAuMDc4NyBsIDAuMTMxOTM5LDAuMDU2MSBjIDAuNTY0MDk0LDAuMjcyMzQgMi4yNTk5MDQsMS43Mzc3OCAxLjIyMzc5Miw5LjIwNTAzIgogICAgICAgc3R5bGU9ImZpbGw6I2ZmZmZmZjtmaWxsLW9wYWNpdHk6MTtmaWxsLXJ1bGU6bm9uemVybztzdHJva2U6bm9uZTtzdHJva2Utd2lkdGg6MC4zNTI3NzgiCiAgICAgICBpZD0icGF0aDE3MS05LTgiIC8+CiAgICA8cGF0aAogICAgICAgZD0ibSA5NC42NjE1MzYsMTMxLjYyODQ3IGMgLTIuMjQ1NzkzLDEuMjEwMDMgLTQuMTIxMTY3LDIuOTYxOTIgLTUuNTU4Mzg5LDUuMDU2MDEgLTMuMTQ3MTQ0LDQuNTY3NDIgLTQuMjI0ODg1LDEwLjc2MzI1IC0yLjU4NTUyMSwxNi41MjY1OCAwLjE5NjUwMSwwLjY5MzIxIDAuNDMyMTU2LDEuMzgxMTMgMC43MTAxNDcsMi4wNjA1OCBsIC05LjU4Njc3NiwtMy45NzgyOCBDIDc0LjAxMTI1MywxNDIuNDA1ODMgNzcuMzQwNDMsMTMxLjgyMjUgODUuMDc3NTg1LDEyNy42NTA5IFoiCiAgICAgICBzdHlsZT0iZmlsbDojZmZmZmZmO2ZpbGwtb3BhY2l0eToxO2ZpbGwtcnVsZTpub256ZXJvO3N0cm9rZTpub25lO3N0cm9rZS13aWR0aDowLjM1Mjc3OCIKICAgICAgIGlkPSJwYXRoMTc1LTItNyIgLz4KICA8L2c+Cjwvc3ZnPgo=&label=Hangar)](https://www.spigotmc.org/resources/discord-role-sync.78829)

[![Discord](https://img.shields.io/discord/710557651758481480.svg?label=Discord&logo=discord)](https://discord.com/invite/JBNejsW)
[![GitLab Issues](https://img.shields.io/gitlab/issues/open/nichogx%2FDiscordRoleSync?label=Issues&logo=gitlab)](https://gitlab.com/nichogx/DiscordRoleSync/-/issues)
[![Pipeline Status](https://gitlab.com/nichogx/DiscordRoleSync/badges/master/pipeline.svg?key_text=Pipeline)](https://gitlab.com/nichogx/DiscordRoleSync/-/commits/master)

DiscordRoleSync is a Minecraft plugin for syncing Discord roles and Minecraft permissions. This syncs Discord to Minecraft only, it is not both ways.

A list of managed Discord roles can be configured and linked o Minecraft groups. If a Discord user gets a role added, they will get added to the Minecraft group. If the user gets the role removed, they will be removed from the Minecraft group.

This can use both SQLite (automatically created, no setup needed) or MySQL. MySQL is recommended for stability on large servers.

This plugin has been tested on Minecraft versions 1.8.8 to 1.21.

## Contributing
This is a side project in maintenance mode, and I do not have too much time to add new features. As such, I've made it open source and welcome contributions.
I've recently picked up support for this plugin again, and am in the process of cleaning up the code. I'm not a Java expert, so feel free to make clean-up, opinionated contributions if you'd like.

The source code can be found on [GitLab](https://gitlab.com/nichogx/DiscordRoleSync). Please see [CONTRIBUTING.md](https://gitlab.com/nichogx/DiscordRoleSync/-/blob/master/CONTRIBUTING.md) for more information.

If needed, you can reach me via GitLab or [Discord](https://discord.com/invite/JBNejsW). Those are also the places to report bugs!

## Installation
You should first install [Vault](https://www.spigotmc.org/resources/vault.34315/) as this plugin will not work without it.

Just copy the .jar to the plugins folder and run the server once to generate the config files. The plugin will error out due to no config, but that's expected on the first run. Go to the config.yml file and add your Discord bot token. To get one:

1. Go to https://discord.com/developers/applications
2. Click "new application" and put a name for your bot
3. In the left sidebar, click "Bot"
4. Click "add bot" and confirm
5. In this page, you can change your bot's picture and username.
6. Turn on "Server Members Intent" - it won't work without this as the bot needs to work with the member list
7. Click copy token and paste it in the config file. Anyone with your token can log in as your bot, so you should keep it secret as if it were a password.
8. Go back to the Discord developer website and on the left sidebar, click "OAuth2"
9. Select "bot" as a scope then copy the link
10. Go to the link you just copied to add the bot to your server

Don't forget to put all roles in the configs. You should put the role IDs, not the role names. To get the ID you should enable developer mode in Discord, then right-click the role and copy ID (it's a number of approximately 18 digits). The same thing applies for the server ID and channel IDs.

## How it Works
It's pretty simple: all your users should use the `/link` command in Discord to link their Minecraft account:

`/link myMCusername`

As soon as they do this, their roles will keep synchronized while they are in the server. When your users get the Discord role, they will automatically get the permission plugin group. Updates are instant.

Staff can also use the `/admlink` command to force link a user:

`/admlink discordID mcUsername`

The Discord ID of the user is a 17 to 20-digit number.

The `/info` and `/unlink` commands are available for staff use. Both accept Discord IDs or Minecraft usernames. By default, these three admin commands are available for everyone that has the `MANAGE ROLES` Discord permission. This can be modified in your Discord server.
The users need to remain in the Discord server to keep their roles. If they leave the server or are unlinked with the `/unlink` command, they are removed from the whitelist and every role is removed from them.

If verification is enabled (`requireVerification: true` on the config), users will either get the code when they are kicked by whitelist (if whitelist management is enabled) or by typing `/drs verify` in the Minecraft chat. This code then needs to be sent in Discord using `/verify <code>`.

## Languages and Translation
Currently, the languages supported (and bundled with the plugin) are:
- English (en_US)
- Portuguese (pt_BR)
- Italian (it_IT)
- French (fr_FR)
- Spanish (es_ES)
- Turkish (tr_TR)
- German (de_DE)
- Japanese (ja_JP)
- Russian (ru_RU)

If you want to add your language, you can copy the en_US.yml file and edit it to your language. If you are interested in having your translation bundled with the plugin, please contact me via Discord or make a merge request on GitLab, I'll be happy to include it :D

As updates to this plugin are released, only English and Portuguese are updated (as those are the languages I speak). Other languages might get out of date and will use English as a default. Please let me know if you'd like to help update these languages!

## Permission Plugins
This plugin should work with every permission plugin that supports Vault.

Tested and confirmed working:
- [LuckPerms](https://www.spigotmc.org/resources/luckperms.28140/) (recommended)
- [Ultra Permissions](https://www.spigotmc.org/resources/ultra-permissions.42678/)
- [PermissionsEx](https://github.com/PEXPlugins/PermissionsEx/releases) (deprecated)
- [PowerRanks](https://www.spigotmc.org/resources/powerranks.64696/)

A note on PermissionsEx: I do not recommend using PermissionsEx as it is deprecated and does not support asynchronous permission adding. Performance might be worse when using it in large servers.

## Online and Offline Server Mode
This plugin is made with primarily online servers in mind. It works with offline servers, however it might conflict with "login plugins" that change a user's UUID after they join. Usage with these plugins is not supported.

Please node that in offline mode servers, linking usernames is case-sensitive.

If you swap between offline and online (or vice-versa), you'll need to delete the database. If you are using SQLite, just delete the database.db file. If you are using MySQL, execute `DROP TABLE syncbot_discordmcusers;`, replacing `syncbot` with the prefix in your config.yml file if you have changed it.

## Permission Nodes

- `discordrolesync.reload`: Use the /drs reload command
- `discordrolesync.botrestart`: Use the /drs botrestart command
- `discordrolesync.notifyupdates`: Users with this permission will be notified when they join if an update is available.

All users are permitted to use the /drs verify command
